<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø´Ø±</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f9f9f9;
      padding: 50px 20px;
      margin: 0;
      text-align: center;
    }

    h1 {
      margin-bottom: 30px;
      color: #333;
    }

    .blue-btn {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 16px 32px;
      margin: 8px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 20px;
    }

    .green-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 16px 32px;
      margin: 8px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 20px;
    }

    .blue-btn:hover {
      background-color: #0056b3;
    }

    .green-btn:hover {
      background-color: #1e7e34;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .button-container button {
      width: 150px;
      font-size: 16px;
    }

    .table-container {
      display: none;
      margin-top: 30px;
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #14a33a;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 14px 18px;
      text-align: center;
      min-width: 120px;
    }

    th {
      background-color: #eeeeee;
      color: #333;
      font-weight: bold;
    }

    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }

    .action-buttons {
      margin-top: 20px;
    }

    .delete-button {
      background-color: #f44336;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      margin: 8px;
    }

    .delete-button:hover {
      background-color: #d32f2f;
    }

    @media (max-width: 600px) {
      button {
        width: 100%;
        margin: 5px 0;
      }

      table {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

<h1>Ø§Ø®ØªØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡</h1>

<div class="button-container">
  <button class="blue-btn" onclick="showTable('mrb')">Ù…Ø±Ø¨Ø¹</button>
  <button class="green-btn" onclick="showTable('reels')">Ø±ÙŠÙ„Ø²</button>
</div>

<div id="table-container" class="table-container"></div>

<script>
  // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ)
  let supabase;  // Ø¥Ø¹Ù„Ø§Ù† Ù…Ø³Ø¨Ù‚ Ù„ØªØ¬Ù†Ø¨ ReferenceError

  // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
  function initSupabase() {
    if (typeof window !== 'undefined' && window.supabase && window.supabase.createClient) {
      const { createClient } = window.supabase;
      const supabaseUrl = 'https://uemmbigftrrsejzucgxo.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlbW1iaWdmdHJyc2VqenVjZ3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTE5NTksImV4cCI6MjA3NDM2Nzk1OX0.ku6ibVn84Pw1a-_2sWTRia3fynuxE7Axi3qXip6oI8k';
      supabase = createClient(supabaseUrl, supabaseKey);
      console.log('âœ… Supabase Ù…ÙÙ†Ø´Ø£ Ø¨Ù†Ø¬Ø§Ø­!');
      return true;
    } else {
      console.error('âŒ Ù…ÙƒØªØ¨Ø© Supabase Ù„Ù… ØªÙØ­Ù…Ù‘Ù„ Ø¨Ø¹Ø¯. Ø§Ù†ØªØ¸Ø± Ø«Ø§Ù†ÙŠØ©...');
      return false;
    }
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      if (!initSupabase()) {
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 500ms Ø¥Ø°Ø§ Ù„Ù… ØªÙØ­Ù…Ù‘Ù„
        setTimeout(initSupabase, 500);
      }
    });
  } else {
    initSupabase();
  }

  // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ø¥Ù†Ø´Ø§Ø¡ supabase Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ù„
  function waitForSupabase(callback) {
    if (supabase) {
      callback();
    } else {
      setTimeout(() => waitForSupabase(callback), 100);
    }
  }

  // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ (ÙŠÙØ´ØºÙ‘Ù„ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ supabase)
  async function testSupabaseConnection() {
    waitForSupabase(async () => {
      console.log('ðŸ” Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase...');
      try {
        // Ø§Ø®ØªØ¨Ø§Ø± 1: Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        const { data: pingData, error: pingError } = await supabase
          .from('pg_catalog')
          .select('version()')
          .limit(1);
        if (pingError) throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ' + pingError.message);

        console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù†Ø§Ø¬Ø­!');

        // Ø§Ø®ØªØ¨Ø§Ø± 2: Ù‡Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ØŸ
        const { count: tableCount, error: tableError } = await supabase
          .from('publishing_schedule')
          .select('*', { count: 'exact', head: true });

        if (tableError && tableError.code === '42P01') {
          console.error('âŒ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯! Ø£Ù†Ø´Ø¦Ù‡ ÙÙŠ Supabase (SQL Editor).');
          alert('âŒ Ø§Ù„Ø¬Ø¯ÙˆÙ„ "publishing_schedule" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!\n\nØ§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Supabase > SQL Editor ÙˆÙ†ÙØ°:\nCREATE TABLE IF NOT EXISTS publishing_schedule (id UUID DEFAULT gen_random_uuid() PRIMARY KEY, type TEXT NOT NULL, row_index INTEGER NOT NULL, column_index INTEGER NOT NULL, value TEXT, checked BOOLEAN);');
          return;
        } else if (tableError) {
          throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ' + tableError.message);
        }

        console.log('âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯! Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', tableCount || 0);

        // Ø§Ø®ØªØ¨Ø§Ø± 3: Ø¥Ø¯Ø±Ø§Ø¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ø³ÙŠØ·
        const { error: insertTestError } = await supabase
          .from('publishing_schedule')
          .insert([{ type: 'test', row_index: 0, column_index: 0, value: 'test_value' }]);

        if (insertTestError) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ:', insertTestError);
          if (insertTestError.message.includes('permission')) {
            alert('âŒ Ù…Ø´ÙƒÙ„Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª! ØªØ¹Ø·ÙŠÙ„ RLS Ø£Ùˆ Ø£Ø¶Ù Policies ÙÙŠ Supabase (Table Editor > publishing_schedule > Policies).');
          } else {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ: ' + insertTestError.message + '\n\nØªØ­Ù‚Ù‚ Ù…Ù† Console.');
          }
          return;
        }

        console.log('âœ… Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ù†Ø§Ø¬Ø­! (Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ Ø§Ù„Ø¢Ù†)');
        await supabase.from('publishing_schedule').delete().eq('type', 'test');
        alert('âœ… ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ¹Ù…Ù„! Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ ÙˆØ§Ù„Ø­ÙØ¸ Ø¬Ø§Ù‡Ø²ÙŠÙ†.\n\nØ§Ù„Ø¢Ù† Ø¬Ø±Ø¨ Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ.');
      } catch (err) {
        console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„:', err);
        alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + err.message + '\n\nØªØ­Ù‚Ù‚ Ù…Ù† Console Ù„Ù„ØªÙØ§ØµÙŠÙ„ØŒ ÙˆØ§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª ÙÙŠ Supabase.');
      }
    });
  }

  // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (ØªØ³ØªØ®Ø¯Ù… waitForSupabase Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø±)
  async function showTable(type) {
    waitForSupabase(() => {
      const tableContainer = document.getElementById('table-container');
      tableContainer.style.display = 'block';
      tableContainer.innerHTML = '';

      let headers = ['Ø§Ù„ÙŠÙˆÙ…', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø·Ø¹', 'Instagram'];

      if (type === 'mrb') {
        headers = ['Ø§Ù„ÙŠÙˆÙ…', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø·Ø¹', 'Facebook', 'Telegram', 'Instagram', 'X', 'WhatsApp'];
      } else if (type === 'reels') {
        headers = ['Ø§Ù„ÙŠÙˆÙ…', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø·Ø¹', 'Instagram', 'TikTok'];
      }

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');

      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headRow.appendChild(th);
      });

      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (let i = 0; i < 8; i++) {
        const row = document.createElement('tr');

        headers.forEach((header) => {
          const cell = document.createElement('td');
          let input;

          if (header === 'Ø§Ù„ÙŠÙˆÙ…' || header === 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø·Ø¹') {
            input = document.createElement('input');
            input.type = 'text';
          } else if (header === 'Ø§Ù„ØªØ§Ø±ÙŠØ®') {
            input = document.createElement('input');
            input.type = 'date';
          } else {
            input = document.createElement('input');
            input.type = 'checkbox';
          }

          cell.appendChild(input);
          row.appendChild(cell);
        });

        tbody.appendChild(row);
      }

      table.appendChild(tbody);
      tableContainer.appendChild(table);

      // Ø£Ø²Ø±Ø§Ø±
      const actionDiv = document.createElement('div');
      actionDiv.className = 'action-buttons';

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„';
      saveBtn.className = 'blue-btn';
      saveBtn.onclick = () => saveTableData(type, table);

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„';
      deleteBtn.classList.add('delete-button');
      deleteBtn.onclick = () => deleteTableData(type, table);

      actionDiv.appendChild(saveBtn);
      actionDiv.appendChild(deleteBtn);

      tableContainer.appendChild(actionDiv);

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      loadSavedData(type, table);
    });
  }

  async function saveTableData(type, table) {
    waitForSupabase(async () => {
      try {
        console.log('ðŸ’¾ Ø¨Ø¯Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„...');
        // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        const { error: deleteError } = await supabase
          .from('publishing_schedule')
          .delete()
          .eq('type', type);

        if (deleteError) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', deleteError);
          throw new Error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ' + deleteError.message);
        }

        // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const data = [];

        rows.forEach((row, rowIndex) => {
          Array.from(row.cells).forEach((cell, colIndex) => {
            const input = cell.querySelector('input');
            if (!input) return;

            data.push({
              type,
              row_index: rowIndex,
              column_index: colIndex,
              value: input.type === 'checkbox' ? null : input.value || '',
              checked: input.type === 'checkbox' ? input.checked : null
            });
          });
        });

        console.log('ðŸ“Š ØªÙ… Ø¬Ù…Ø¹ ' + data.length + ' Ø³Ø¬Ù„ Ù„Ù„Ø­ÙØ¸.');

        // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { error: insertError } = await supabase.from('publishing_schedule').insert(data);

        if (insertError) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬:', insertError);
          throw new Error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + insertError.message);
        } else {
          console.log('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!');
          alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
          loadSavedData(type, table);  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
        }
      } catch (err) {
        console.error('Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø§Ù„Ø­ÙØ¸:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ' + err.message + '\n\nØªØ­Ù‚Ù‚ Ù…Ù† Console Ù„Ù„ØªÙØ§ØµÙŠÙ„.');
      }
    });
  }

  async function loadSavedData(type, table) {
    waitForSupabase(async () => {
      try {
        const { data, error } = await supabase
          .from('publishing_schedule')
          .select('*')
          .eq('type', type)
          .order('row_index')
          .order('column_index');

        if (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error);
          return;
        }

        const rows = table.querySelectorAll('tbody tr');
        data.forEach(entry => {
          const row = rows[entry.row_index];
          if (!row) return;
          const cell = row.cells[entry.column_index];
          if (!cell) return;
          const input = cell.querySelector('input');
          if (!input) return;

          if (input.type === 'checkbox') {
            input.checked = entry.checked || false;
          } else {
            input.value = entry.value || '';
          }
        });

        console.log('ðŸ“¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ ' + data.length + ' Ø³Ø¬Ù„.');
      } catch (err) {
        console
