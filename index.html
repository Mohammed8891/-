<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>جدول النشر</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
  font-family: 'Arial', sans-serif;
  background-color: #f9f9f9;
  padding: 0;
  margin: 0;
  text-align: center;
  height: 100vh;
  overflow: hidden; /* يمنع سكروول الصفحة نفسها */
}


    h1 {
      margin-bottom: 30px;
      color: #333;
    }

    .blue-btn, .green-btn {
      color: white;
      border: none;
      padding: 16px 32px;
      margin: 8px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 20px;
    }

    .blue-btn {
      background-color: #007BFF;
    }

    .green-btn {
      background-color: #28a745;
    }

    .blue-btn:hover {
      background-color: #0056b3;
    }

    .green-btn:hover {
      background-color: #1e7e34;
    }

    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .button-container button {
      width: 150px;
      font-size: 16px;
    }

    /* تفعيل السكروول على محتوى الجدول */
    .table-container {
      display: none;
      margin-top: 30px;
      max-height: 500px;      /* ارتفاع ثابت للمنطقة */
      overflow-y: auto;       /* سكروول رأسي */
      overflow-x: auto;       /* سكروول أفقي عند الحاجة */
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #00bd23;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #dcdcdc;
      padding: 14px 18px;
      text-align: center;
      min-width: 160px;
    }

    th {
      background-color: #f5f5f5;
      color: #333;
      font-weight: bold;
    }

    tr:hover {
      background-color: #fafafa;
    }

    input[type="text"], input[type="date"] {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .day-field {
      width: 200px !important;
    }

    .title-field {
      width: 330px !important;
    }

    input[type="checkbox"] {
      transform: scale(1.2);
      cursor: pointer;
    }

    .action-buttons {
      margin-top: 20px;
    }

    .delete-button {
      background-color: #f44336;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      margin: 8px;
    }

    .delete-button:hover {
      background-color: #d32f2f;
    }

    @media (max-width: 600px) {
      button {
        width: 100%;
        margin: 5px 0;
      }

      table {
        font-size: 14px;
      }

      .title-field {
        width: 260px !important;
      }

      .day-field {
        width: 160px !important;
      }
    }
  </style>
</head>
<body>
  <div id="logo">
    <img src="لوجو الشيخ.png" height="50px" width="75px" style="margin-right: 15px;">
  </div>

  <h1>اختر الجدول الذي تريده</h1>

  <div class="button-container">
    <button class="blue-btn" onclick="showTable('mrb')">مربع</button>
    <button class="green-btn" onclick="showTable('reels')">ريلز</button>
  </div>

  <div id="table-container" class="table-container"></div>

  <script>
    let supabaseClient = null;
    const supabaseUrl = 'https://uemmbigftrrsejzucgxo.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlbW1iaWdmdHJyc2VqenVjZ3hvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3OTE5NTksImV4cCI6MjA3NDM2Nzk1OX0.ku6ibVn84Pw1a-_2sWTRia3fynuxE7Axi3qXip6oI8k';

    function initializeSupabase() {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;

        const interval = setInterval(() => {
          attempts++;
          if (window.supabase && typeof window.supabase.createClient === 'function') {
            clearInterval(interval);
            try {
              const { createClient } = window.supabase;
              supabaseClient = createClient(supabaseUrl, supabaseKey);
              resolve(supabaseClient);
            } catch (err) {
              clearInterval(interval);
              reject(err);
            }
          } else if (attempts >= maxAttempts) {
            clearInterval(interval);
            const err = new Error('فشل تحميل مكتبة Supabase بعد 5 ثوانٍ.');
            alert(err.message);
            reject(err);
          }
        }, 100);
      });
    }

    function waitForClient(callback) {
      if (supabaseClient) {
        callback(supabaseClient);
      } else {
        initializeSupabase().then(client => {
          supabaseClient = client;
          callback(client);
        }).catch(err => {
          alert('خطأ في إعداد Supabase: ' + err.message);
        });
      }
    }

    function showTable(type) {
      waitForClient(async (client) => {
        const tableContainer = document.getElementById('table-container');
        tableContainer.style.display = 'block';
        tableContainer.innerHTML = '';

        let headers = ['اليوم', 'التاريخ', 'عنوان المقطع', 'Instagram'];
        if (type === 'mrb') {
          headers = ['اليوم', 'التاريخ', 'عنوان المقطع', 'Facebook', 'Telegram', 'Instagram', 'X', 'WhatsApp'];
        } else if (type === 'reels') {
          headers = ['اليوم', 'التاريخ', 'عنوان المقطع', 'Instagram', 'TikTok'];
        }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');

        headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = header;
          headRow.appendChild(th);
        });

        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        /* جعل عدد الصفوف 30 بدل 8 */
        for (let i = 0; i < 30; i++) {
          const row = document.createElement('tr');
          headers.forEach((header) => {
            const cell = document.createElement('td');
            let input;
            if (header === 'اليوم') {
              input = document.createElement('input');
              input.type = 'text';
              input.classList.add('day-field');
            } else if (header === 'عنوان المقطع') {
              input = document.createElement('input');
              input.type = 'text';
              input.classList.add('title-field');
            } else if (header === 'التاريخ') {
              input = document.createElement('input');
              input.type = 'date';
            } else {
              input = document.createElement('input');
              input.type = 'checkbox';
            }
            cell.appendChild(input);
            row.appendChild(cell);
          });
          tbody.appendChild(row);
        }

        table.appendChild(tbody);
        tableContainer.appendChild(table);

        const actionDiv = document.createElement('div');
        actionDiv.className = 'action-buttons';

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'حفظ الجدول';
        saveBtn.className = 'blue-btn';
        saveBtn.onclick = () => saveTableData(type, table, client);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'حذف الجدول';
        deleteBtn.classList.add('delete-button');
        deleteBtn.onclick = () => deleteTableData(type, table, client);

        actionDiv.appendChild(saveBtn);
        actionDiv.appendChild(deleteBtn);

        tableContainer.appendChild(actionDiv);

        loadSavedData(type, table, client);
      });
    }

    async function saveTableData(type, table, client) {
      try {
        const { error: deleteError } = await client
          .from('publishing_schedule')
          .delete()
          .eq('type', type);

        if (deleteError) throw new Error(deleteError.message);

        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const data = [];

        rows.forEach((row, rowIndex) => {
          Array.from(row.cells).forEach((cell, colIndex) => {
            const input = cell.querySelector('input');
            if (!input) return;

            data.push({
              type,
              row_index: rowIndex,
              column_index: colIndex,
              value: input.type === 'checkbox' ? null : input.value || '',
              checked: input.type === 'checkbox' ? input.checked : null
            });
          });
        });

        const { error: insertError } = await client.from('publishing_schedule').insert(data);

        if (insertError) throw new Error(insertError.message);

        alert('تم حفظ الجدول بنجاح!');
        loadSavedData(type, table, client);
      } catch (err) {
        alert('خطأ في الحفظ: ' + err.message);
      }
    }

    async function loadSavedData(type, table, client) {
      try {
        const { data, error } = await client
          .from('publishing_schedule')
          .select('*')
          .eq('type', type)
          .order('row_index')
          .order('column_index');

        if (error) return;

        const rows = table.querySelectorAll('tbody tr');
        data.forEach(entry => {
          const row = rows[entry.row_index];
          if (!row) return;
          const cell = row.cells[entry.column_index];
          if (!cell) return;
          const input = cell.querySelector('input');
          if (!input) return;

          if (input.type === 'checkbox') {
            input.checked = entry.checked || false;
          } else {
            input.value = entry.value || '';
          }
        });
      } catch (err) {}
    }

    async function deleteTableData(type, table, client) {
      const confirmed = confirm('هل أنت متأكد؟');
      if (!confirmed) return;

      try {
        const { error } = await client
          .from('publishing_schedule')
          .delete()
          .eq('type', type);

        if (error) throw new Error(error.message);

        const inputs = table.querySelectorAll('input');
        inputs.forEach(input => {
          if (input.type === 'checkbox') input.checked = false;
          else input.value = '';
        });

        alert('تم الحذف بنجاح!');
      } catch (err) {
        alert('خطأ في الحذف: ' + err.message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      waitForClient(() => {});
    });
  </script>
</body>
</html>
